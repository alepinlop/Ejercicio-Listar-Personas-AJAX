
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8"/>
    <title>Ejercicio Listado Personas. AJAX</title>
    <style type="text/css">
      h3{
        color: red;
      }
			
			/* CSS para el formulario:   */
			.formPersonas{
				visibility: hidden;  
				position: absolute;
				top: 20%;
				left: 20%;
				z-index:11;
				background-color: pink;
				border: 2px solid maroon;
				border-radius: 15px;
				padding: 1em;
				color: red;
				
			/*	opacity:0;   */
			/*	transition: all 1s;   */
			}

			.formPersonas div label {
				display: block;
				margin-top: .5em;
			}
			
			.formPersonas .btn {
				display: block;
				margin-top: 1em;
			}
			
			
			.ver {
				visibility: visible;  
				opacity:1;
			}
			
    </style>
		<!--<script type="text/javascript" src="util2AJAX.js"></script>-->
    <script type="text/javascript">
		
			// Peticion inicial para cargar la tabla de personas al cargar la página.
			var peti = new XMLHttpRequest();
	
			// Petición para añadir una nueva persona a la tabla.
			var peti2 = new XMLHttpRequest();

			// Petición para editar una persona en la tabla.
			var peti3 = new XMLHttpRequest();

			// Petición para borrar una persona de la tabla.
			var peti4 = new XMLHttpRequest();

			var url = 'http://localhost/AJAX/CLIENTE_REC/EjercicioListaPersonas/servidor.php';

			let personaEnEdicion = null;

			window.onload = () => {
			//	var btNuevaPersona = document.getElementById("btNuevaPersona");
				document.getElementById("btNuevaPersona").onclick = muestraForm; // Asignar la función para mostrar el formulario

				peti.onreadystatechange = pintaPersonas; // Asignar la función para llamar las personas de la tabla

				peti.open('POST', url);
				peti.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

				let parametro = JSON.stringify({ 
					servicio: "listar",
				});
				
				peti.send(parametro);
			}

			const pintaPersonas = () => {
				if(peti.readyState == 4) {
					if(peti.status == 200) {
						console.log('Datos recibidos del servidor:', peti.responseText);

						//Aquí metemos el código para poner las personas en la tabla.
						let personas = JSON.parse(peti.responseText); // Hace una llamada a los elementos del fichero de texto.
						console.log("personas", personas);

						pintaTabla(personas); // Llamada a la función que pinta la tabla, donde 'personas' es el array de objetos que contiene los datos de las personas.
					}
				}
			}


			const pintaTabla = (arrPersonas) => {
				let tabla = document.getElementById("filas_tabla"); // Llamada al cuerpo de la tabla

				tabla.innerHTML = ""; // Limpiamos la tabla

				// Recorremos el array de personas y vamos creando las filas y celdas de la tabla.
				for (let i = 0; i < arrPersonas.length; i++) {
					let fila = document.createElement("tr");

					// Código muy largo, vamos a optimizarlo.

					/*let celdaID = document.createElement("td");
					celdaID.innerHTML = arrPersonas[i].ID;
					fila.appendChild(celdaID);

					let celdaDNI = document.createElement("td");
					celdaDNI.innerHTML = arrPersonas[i].DNI;
					fila.appendChild(celdaDNI);

					let celdaNombre = document.createElement("td");
					celdaNombre.innerHTML = arrPersonas[i].NOMBRE;
					fila.appendChild(celdaNombre);

					let celdaApellidos = document.createElement("td");
					celdaApellidos.innerHTML = arrPersonas[i].APELLIDOS;
					fila.appendChild(celdaApellidos);

					let celdaBorrar = document.createElement("td");
					let botonBorrar = document.createElement("button");
					botonBorrar.innerHTML = "Borrar";
					celdaBorrar.appendChild(botonBorrar);
					fila.appendChild(celdaBorrar);

					let celdaEditar = document.createElement("td");
					let botonEditar = document.createElement("button");
					botonEditar.innerHTML = "Editar";
					celdaEditar.appendChild(botonEditar);
					fila.appendChild(celdaEditar);*/

					let persona = arrPersonas[i]; // Obtenemos la persona actual del array
					// Creamos las celdas de la fila de forma más compacta
					fila.innerHTML = `
						<td>${persona.ID}</td>
						<td>${persona.DNI}</td>
						<td>${persona.NOMBRE}</td>
						<td>${persona.APELLIDOS}</td>
						<td><button class="btnBorrar">Borrar</button></td>
						<td><button class="btnEditar">Editar</button></td>
					`;

					// Añadir los eventos a los botones de borrar y editar
					// Devolvemos el primer elemento que coincida con el selector CSS
					fila.querySelector(".btnBorrar").onclick = () => {
						console.log("Borrar persona con ID:", persona.ID);
						// Aquí se llamaría a la función para borrar la persona
						borrarPersona(persona.ID);
					};

					// Realizamos lo mismo para el botón de editar
					fila.querySelector(".btnEditar").onclick = () => {
						console.log("Editar persona con ID:", persona.ID);
						// Aquí se llamaría a la función para editar la persona
						editarPersona(persona);
					};

					tabla.appendChild(fila);
				}
			};

			// Función para mostrar el formulario de añadir persona.
			const muestraForm = () => {
				console.log("Llega al formulario");
				// Mostrar el formulario
				document.getElementById("formPersonas").classList.add("ver");

				// Función del botón Añadir
				document.getElementById("btAnade").onclick = anade;

				// Función del botón cancelar
				document.getElementById("btCancelar").onclick  = cancelar;


			}

			// Función que pone el formulario en su estado inicial.
			const reseteaForm = () => {
				// Limpiar los campos del formulario
				document.getElementById("dni").value = "27473339T";
				document.getElementById("nombre").value = "Marco Elio";
				document.getElementById("apellidos").value = "García Gomariz";

				// Cambiar el texto del botón Añadir
				document.querySelector("legend").innerText = "Alta en el servicio";
				document.getElementById("btAnade").innerText = "Añadir";
			}

			const cancelar = () => {
				console.log("pulsado el boton cancelar");
				// Ocultar el formulario
				document.getElementById("formPersonas").classList.remove("ver");
				reseteaForm(); // Reseteamos el formulario para que vuelva a su estado inicial.
			}

			const anade = () => {
					console.log("pulsado el boton añadir");
					// Recoger los datos del formulario
					let dni = document.getElementById("dni").value;
					let nombre = document.getElementById("nombre").value;
					let apellidos = document.getElementById("apellidos").value;
					console.log("dni", dni);
					console.log("nombre", nombre);
					console.log("apellidos", apellidos);

					// Enviar los datos a la tabla
					peti2.onreadystatechange = function() {
						if (this.readyState == 4 && this.status == 200) {
							console.log('Datos tras inserción:', this.responseText);
							let personas = JSON.parse(this.responseText); // Hace una llamada a los elementos del fichero de texto.
							pintaTabla(personas); // Llamada a la función que pinta la tabla, donde 'personas' es el array de objetos que contiene los datos de las personas.

							// ocultar y limpiar formulario
      						document.getElementById("formPersonas").classList.remove("ver");
						} else {
							console.error('Error al añadir la persona:', this.statusText);
						}
					};

					// Configurar la petición para enviar los datos al servidor
					peti2.open('POST', url);
					peti2.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

					let parametro = JSON.stringify({ 
						servicio: "insertar",
						dni,
						nombre,
						apellidos,
					});

					console.log("parametro", parametro);

					peti2.send(parametro);
			}

			// Funciones para editar una persona
			// La primera solo se encarga de modificar los datos del formulario y recogerlos.
			const editarPersona = (persona) => {
				// Primero visualizamos el formulario
				document.getElementById("formPersonas").classList.add("ver");

				// Cambiamos el contenido del formulario para editar
				document.querySelector("legend").innerText = "Modifica en el servicio";
				document.getElementById("btAnade").innerText = "Editar";

				personaEnEdicion = persona; // Guardamos la persona en edición

				// Rellenamos los campos del formulario con los datos de la persona a editar
				document.getElementById("dni").value = persona.DNI;
				document.getElementById("nombre").value = persona.NOMBRE;
				document.getElementById("apellidos").value = persona.APELLIDOS;

				// Asignar la función del botón editar
				document.getElementById("btAnade").onclick = modifica;

				document.getElementById("btCancelar").onclick = cancelar; // Asignar la función del botón cancela
			};

			// La función que modifica los datos de la persona.
			const modifica = () => {
				console.log("Pulsado el boton editar");

				let dni = document.getElementById("dni").value;
				let nombre = document.getElementById("nombre").value;
				let apellidos = document.getElementById("apellidos").value;

				// Recordemos que peti3 es la petición para editar una persona.
				peti3.open('POST', url); // Abrimos la petición por POST a la URL del servidor.
				peti3.setRequestHeader("Content-Type", "application/x-www-form-urlencoded"); // Establecemos el tipo de contenido que vamos a enviar.

				// Enviamos los datos al servidor (a la tabla)
				peti3.onreadystatechange = function () {
					if (this.readyState == 4 && this.status == 200) {
						// Si la petición se ha completado correctamente, procesamos la respuesta.
						try {
							let personas = JSON.parse(this.responseText);
							console.log('Datos tras edición:', personas);
							pintaTabla(personas);
							document.getElementById("formPersonas").classList.remove("ver");
						} catch (e) {
							// Si hay un error al parsear la respuesta, mostramos un mensaje de error.
							console.error('Respuesta no válida JSON:', this.responseText);
						}
					}
				};

				// Preparamos el parametro que envia los datos al servidor.
				let parametro = JSON.stringify({ 
					servicio: "modificar",
					id: personaEnEdicion.ID, // Usamos el ID de la persona en edición
					dni,
					nombre,
					apellidos,
				});

				peti3.send(parametro); // Enviamos los datos al servidor.

				// Reseteamos el formulario para que vuelva a su estado inicial.
				reseteaForm();
			};

			// Función para borrar una persona
			const borrarPersona = (id) => {
				// Primero mostramos un mensaje de confirmación al usuario
				if (confirm("¿Estás seguro de que quieres borrar esta persona?")) {
				// Configurar la petición para borrar la persona
				peti4.onreadystatechange = function() {
					if (this.readyState == 4 && this.status == 200) {
						// Si la petición se ha completado correctamente, procesamos la respuesta.
						try {
							console.log('Datos tras borrado:', this.responseText);
							let personas = JSON.parse(this.responseText); // Hace una llamada a los elementos del fichero de texto.
							pintaTabla(personas); // Llamada a la función que pinta la tabla, donde 'personas' es el array de objetos que contiene los datos de las personas.
						} catch (e) {
							// Si hay un error al parsear la respuesta, mostramos un mensaje de error.
							console.error('Respuesta no válida JSON:', this.responseText);
						}
					}
				};

				peti4.open('POST', url);
				peti4.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
				let parametro = JSON.stringify({ 
					servicio: "borrar",
					id: id, // Pasamos el ID de la persona a borrar
				});

				console.log("parametro borrar", parametro);
				peti4.send(parametro); // Enviamos la petición al servidor
				} else {
					console.log("Borrado cancelado por el usuario.");
				}

			};

    </script>
  </head>
  <body>
    <h3>Registro de Usuarios</h3>
		
		<div id="formPersonas" class="formPersonas ">
			<fieldset>
				<legend>Alta en el servicio</legend>
				<div>
					<label for="dni">DNI</label>
					<input type="text" id="dni" size="10" maxlength="9" value="27473339T"/>
				</div>
				<div>
					<label for="nombre">Nombre</label>
					<input type="text" id="nombre" value="Marco Elio"/>
				</div>
				<div>
					<label for="apellidos">Apellidos</label>
					<input type="text" id="apellidos" size="40" value="García Gomariz"/>
				</div>
				<div class="btn">
					<button id="btAnade">Añadir </button> 
					<button id="btCancelar">Cancelar </button>
				</div>
			</fieldset>
		</div>
		
		
		
		<br/>
	 <button class="btn" id="btNuevaPersona">Nueva persona</button> 
	 <br><br>
		<table id="tabla_personas" border="1">
			<tr>
				<th>ID</th>
				<th>DNI</th>
				<th>NOMBRE</th>
				<th>APELLIDOS</th>
				<th>Borrar</th>
				<th>Editar</th>
			</tr>
			
			<tbody id="filas_tabla">
			
			</tbody>
		</table>

		<br><br>
		
  </body>
</html>
